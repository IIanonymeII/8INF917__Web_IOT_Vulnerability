const grid = new gridjs.Grid({
	columns: [
		{
			name: 'id',
			hidden: true,
		},
		{
			name: 'Mise à jour',
			width: '15%'
		},
		{
			name: 'Titre',
			attributes: (cell) => {
				if (cell)
					return {
						'pointer': ''
					}
			}
		},
		{
			name: 'Sévérité',
			width: '10%',
			attributes: (cell, row, column) => {
				if (cell) {
					return {
						class: `severity back ${cell}`,
						style: 'text-align: center; border: 1px solid white;'
					};
				}
			}
		},
		{
			name: 'Appareils affectés',
			width: '15%'
		}
	],
	server: {
		url: "/api/all?",
		then: data => {
			console.log(data);
			return data.data.map((item) => {
				const lastUpdated = new Date(item.last_updated);
				return [item.id, lastUpdated.toLocaleString(), item.title, item.severity, item.devices_affected]
			});
		},
		total: data => data.total,
	},
	search: {
		server: {
			url: (prev, keyword) => `${prev}&search=${keyword}`
		}
	},
	pagination: {
		limit: 10,
		summary: true,
		server: {
			url: (prev, page, limit) => `${prev}&page=${page}`
		}
	},
	sort: {
		server: {
			url: (prev, columns) => {
				if (!columns.length)
					return prev;

				const col = columns[0];
				const dir = col.direction === 1 ? 'asc' : 'desc';
				let colName = ['id', 'last_updated', 'title', 'severity', 'devices_affected'][col.index];

				return `${prev}&order=${colName}&dir=${dir}`;
			}
		}
	},
	resizable: true,
	fixedHeader: true,
	language: {
		search: {
			placeholder: '🔍 Recherche...',
		},
		sort: {
			sortAsc: "Trier la colonne dans l'ordre croissant",
			sortDesc: "Trier la colonne dans l'ordre décroissant",
		},
		pagination: {
			previous: 'Précédent',
			next: 'Suivant',
			navigate: (page, pages) => `Page ${page} de ${pages}`,
			page: (page) => `Page ${page}`,
			showing: 'Affichage des résultats',
			of: 'sur',
			to: 'à',
			results: '',
		},
		loading: 'Chargement...',
		noRecordsFound: 'Aucun résultat trouvé',
		error: 'Une erreur est survenue lors de la récupération des données',
	}
}).render(document.querySelector('table'));

grid.on('cellClick', (...args) => {
	const id = args[3].cells[0].data;
	const cellId = args[2].id;
	if (cellId === "titre")
		window.location.href = `/details/${id}`;
});