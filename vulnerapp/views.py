from django.shortcuts import render
import requests
from django.http import JsonResponse
from django.conf import settings
from database.models import CVE, Product
from django.db.models import Count, Subquery, OuterRef
from django.shortcuts import get_object_or_404

from database.functions import update_database


def fetch_api(request):
    return update_database()

def home_page(request):
    vulnerabilities = CVE.objects.all().order_by('-last_updated')
    return render(request, 'home.html', {'vulnerabilities': vulnerabilities})

def all_page(request):
    vulnerabilities = CVE.objects.all().order_by('-last_updated')
    return render(request, 'all.html', {'vulnerabilities': vulnerabilities})

def details_page(request, cve_id):
	cve = CVE.objects.get(id=cve_id)
	return render(request, 'details.html', {'cve': cve})

def vendors_page(request):
    vendors = Product.objects.values('vendor').annotate(
        product_count=Count('id')
    )
    vendors = vendors.annotate(
        cve_count=Count('cve', distinct=True)
    )
    return render(request, 'home_vendors.html', {'vendors': vendors})

def vendor_details_page(request, vendor_name: str):
    cves = CVE.objects.filter(affected_products__vendor=vendor_name).distinct()
    return render(request, 'vendor_detail.html', {'cves': cves, "vendor_name": vendor_name})