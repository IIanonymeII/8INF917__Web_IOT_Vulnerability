from django.shortcuts import render
import requests
from django.http import JsonResponse
from django.conf import settings
from database.models import CVE, Product
from django.db.models import Count
from django.shortcuts import get_object_or_404

from database.functions import update_database


def fetch_api(request):
    return update_database()

def home_page(request):
    vulnerabilities = CVE.objects.all().order_by('-last_updated')[:5]
    return render(request, 'home.html', {'vulnerabilities': vulnerabilities})

def all_page(request):
    vulnerabilities = CVE.objects.all().order_by('-last_updated')
    return render(request, 'all.html', {'vulnerabilities': vulnerabilities})

def details_page(request, cve_id):
	cve = CVE.objects.get(id=cve_id)
	return render(request, 'details.html', {'cve': cve})

def products_page(request):
    products_by_vendor = Product.objects.values('vendor').annotate(cve_count=Count('cve'))
    
    products_by_vendor = Product.objects.values('vendor').annotate(cve_count=Count('cve', distinct=True))
    
    return render(request, 'home_product.html', {'vulnerabilities': products_by_vendor})

def products_name_page(request, product_name: str):
    products = Product.objects.filter(vendor=product_name)
    vulnerabilities = CVE.objects.filter(affected_products__in=products).distinct()  # Get unique CVEs
    return render(request, 'home.html', {'vulnerabilities': vulnerabilities})