from django.shortcuts import render
import requests
from django.http import JsonResponse
from django.conf import settings
from database.models import CVE
from database.views import update_database_from_nvd


def get_nvd_vulnerabilities():
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    # params = {'api_key': settings.NVD_API_KEY}  # Assuming you have NVD_API_KEY defined in your settings
    # print(params)
    response = requests.get(url)
    if response.status_code == 200:
        return response.json()
    else:
        return None
    

def update_bd(request):
    return update_database_from_nvd()

def get_iot_vulnerabilities_from_database(request):
    iot_keywords = ['iot', 'internet of things', 'connected devices', 'remote',  'connected  device', 'home', 'appliances', 'appliances', 'smart', 'connected', 'personnal', 'connect']
    iot_vulnerabilities = []
    for keyword in iot_keywords:
        iot_vulnerabilities += list(CVE.objects.filter(descriptions__value__icontains=keyword))
    print(f"Found {len(iot_vulnerabilities)} IoT-related vulnerabilities in the database.")
    iot_vulnerabilities = [cve.to_dict() for cve in iot_vulnerabilities]
    return JsonResponse({'iot_vulnerabilities': iot_vulnerabilities})


def home_page(request):
    vulnerabilities = CVE.objects.all().order_by('-lastModified')[:10]
    return render(request, 'home.html', {'vulnerabilities': vulnerabilities})

def details_page(request, cve_id):
	cve = CVE.objects.get(id=cve_id)
	return render(request, 'details.html', {'cve': cve})