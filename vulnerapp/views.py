from django.shortcuts import render
import requests
from django.http import JsonResponse
from django.conf import settings
from database.models import CVE, Product
from django.db.models import Count, Subquery, OuterRef
from django.shortcuts import get_object_or_404
from django.core.paginator import Paginator

def home_page(request):
    vulnerabilities = CVE.objects.all().order_by('-release_date')[:20]
    return render(request, 'home.html', {'vulnerabilities': vulnerabilities})

def all_page(request):
    year = request.GET.get('year')
    vulnerabilities_list = CVE.objects.all()

    years = vulnerabilities_list.dates('release_date', 'year').reverse()
    if year:
        vulnerabilities_list = vulnerabilities_list.filter(release_date__year=year)

    paginator = Paginator(vulnerabilities_list, 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    return render(request, 'all.html', {'page_obj': page_obj, 'years': years})

def details_page(request, cve_id):
	cve = CVE.objects.get(id=cve_id)
	return render(request, 'details.html', {'cve': cve})

def vendors_page(request):
	search_query = request.GET.get('search', '')

	vendors = Product.objects.filter(vendor__icontains=search_query).values('vendor').annotate(
		product_count=Count('id')
	)
	vendors = vendors.annotate(
		cve_count=Count('cve', distinct=True)
	)

	paginator = Paginator(vendors, 20)
	page_number = request.GET.get('page')
	page_obj = paginator.get_page(page_number)

	return render(request, 'home_vendors.html', {'page_obj': page_obj})

def vendor_details_page(request, vendor_name: str):
    cves = CVE.objects.filter(affected_products__vendor=vendor_name).distinct().order_by('-release_date')

    # Obtenez une liste de tous les vendeurs, triés par le nombre de CVE associées
    vendors = Product.objects.values('vendor').annotate(
        cve_count=Count('cve', distinct=True)
    ).order_by('-cve_count')

    # Convertir le queryset en une liste de dictionnaires pour pouvoir utiliser la méthode index
    vendors_list = list(vendors)

    # Trouver l'index du vendeur actuel dans la liste, qui sera son rang
    vendor_rank = next((index for (index, d) in enumerate(vendors_list) if d["vendor"] == vendor_name), None)

    return render(request, 'vendor_detail.html', {'cves': cves, "vendor_name": vendor_name, "vendor_rank": vendor_rank + 1 if vendor_rank is not None else None, "vendors_count": len(vendors_list)})


def search_page(request):
    query = request.GET.get('q')
    # Récupère les produits qui contiennent le query dans leur modèle ou vendor
    products = Product.objects.filter(model__icontains=query) | Product.objects.filter(vendor__icontains=query)
    # Regroupe par product et compte le nombre de cve_id
    products = products.values('cve_id').distinct()

    # Récupère les cves qui contiennent le query dans leur titre ou dans leur description ou dans leur produit
    cves = CVE.objects.filter(title__icontains=query) | CVE.objects.filter(description__icontains=query) | CVE.objects.filter(affected_products__in=products)
    cves = cves.distinct().order_by('-release_date')

    return render(request, 'search.html', {'cves': cves, 'query': query})