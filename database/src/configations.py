

from database.models import CPEMatch, Configuration, Node


def create_or_update_configations(cve, cve_configurations):
    try:
        # Create or update configurations
        for configuration_data in cve_configurations: #cve_data.get('configurations', []):
            configuration, created = Configuration.objects.get_or_create(cve=cve)
            
            # Create or update nodes
            for node_data in configuration_data['nodes']:
                node, created = Node.objects.get_or_create(
                    configuration=configuration,
                    operator=node_data['operator'],
                    negate=node_data['negate']
                )
                
                # Create or update CPE matches
                for cpe_match_data in node_data['cpeMatch']:
                    CPEMatch.objects.update_or_create(
                        node=node,
                        vulnerable=cpe_match_data['vulnerable'],
                        criteria=cpe_match_data['criteria'],
                        matchCriteriaId=cpe_match_data['matchCriteriaId']
                    )
        
    except Exception as exc:
        raise Exception(f"Failed to create or update weakness_data: {exc}")
